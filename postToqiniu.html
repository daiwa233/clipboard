<!--
 * @Author: your name
 * @Date: 2019-11-27 20:43:17
 * @LastEditTime : 2020-01-28 14:40:07
 * @LastEditors  : Please set LastEditors
 * @Description: In User Settings Edit
 * @FilePath: \七牛上传图片\postToqiniu.html
 -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
 <link rel="stylesheet" href="./style.css">
</head>

<body>
  <div class="ab-o-oa" aria-hidden="true">
    <div class="ab-o-Jb"></div>
    <div class="Wa-sa-c a-i-kd-ta-Zg Xc-ag-fa"></div>
    <div class="Wa-sa-c a-i-kd-a-Ab-Zg Xc-ag-fa"></div>
    <div class="Wa-ka-oa-r Wa-ka-oa-Zk">
      <div class="Wa-ka-oa-qc-V">将图片拖到此处</div>
      <div class="Wa-ka-oa-qc-r">或使用“新建”按钮。</div>
    </div>
  </div>
  <div id="content"></div>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script>
    window.addEventListener('paste', function (e) {
      e.preventDefault();
      
      const {clipboardData} = e;
      console.log(clipboardData.items)
      console.log(clipboardData.types)
      // 对于不支持获取剪贴板上的数据处理
      if (!(clipboardData && clipboardData.items)) return console.log('当前环境不支持获取剪贴板上的数据');
      // 判断不是图片文件则提示 ps: 不支持复制windows系统中的图片文件
      const isFile = clipboardData.types.some((item) => {
        return item === "Files";
      })
      if (!isFile) return console.log("请粘贴图片");
      
      let items = clipboardData.items,
           blob = null,
       localUrl = null;

      for (let i = 0; i < items.length; i++) {

        if (items[i].type.includes("html")) {
          // getAsString()方法是异步的。。。 坑
          items[i].getAsString((src) => {
           
            let a = src.split("=")[1];
            if(a) localUrl = a.split(">")[0].trim();
            localUrl && console.log(`本次复制的图片的地址是${localUrl}`);

          })
        }
        if (items[i].type.includes("image")) {

          blob = items[i].getAsFile();
        }
        
      }
      
      if (blob) {
        
        // let reader = new FileReader();
        // reader.readAsDataURL(blob)
        // reader.onload = function (e) {
        //   let base64 = e.target.result.split(',')[1];
        // }
          let fragment = new FormData();
          fragment.append("imgFile", blob);
          const config = {
            headers: {
              "Content-Type": "multipart/form-data"
            },
            onUploadProgress: e => {
              console.log(e);
              var completeProgress = ((e.loaded / e.total * 100) | 0) + "%";
              console.log(completeProgress);
            }
          }
          axios.post("http://localhost:4000/upload", fragment, config).then(res => {

            const {
              data
            } = res;
            document.getElementById('content').innerHTML = `本次操作的外链是 http://img.start-here.cn/${data.key}`;
          }).catch(err => {
            alert('笨比，出错了')
          })
        
      } else {
        console.log(`粘贴在此处只支持截图工具截的图片或者网页中右键复制的图片请选择拖拽或者上传图片`);
      }
    });
  </script>
</body>

</html>